<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge Cases Test - Location Filter</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background-color: #f8f9fa;
        }
        h1 {
            color: #007bff;
            margin-bottom: 2rem;
        }
        .test-section {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        .test-description {
            color: #666;
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .test-button {
            padding: 0.75rem 1.5rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-result {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }
        .test-result.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .test-result.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .test-result.warning {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        .console-output {
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        .console-output div {
            margin-bottom: 0.25rem;
        }
        .console-log { color: #00ff00; }
        .console-warn { color: #ffc107; }
        .console-error { color: #ff4444; }
        .console-debug { color: #888; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Edge Cases & Error Scenarios Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Documents Without Location Data</h2>
        <div class="test-description">
            Tests that documents without location data are treated as unfiltered when no filters are active,
            but excluded when location filters are applied.
        </div>
        <button class="test-button" onclick="testDocumentsWithoutLocationData()">Run Test</button>
        <div id="test1-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: No Results Message Display</h2>
        <div class="test-description">
            Tests that an appropriate message is displayed when no results match the active filters,
            showing which filters are currently applied.
        </div>
        <button class="test-button" onclick="testNoResultsMessage()">Run Test</button>
        <div id="test2-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Location Data Load Failure</h2>
        <div class="test-description">
            Tests that the gallery functions correctly when location data fails to load,
            with filters disabled and search functionality still working.
        </div>
        <button class="test-button" onclick="testLocationDataFailure()">Run Test</button>
        <div id="test3-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Console Logging for Debugging</h2>
        <div class="test-description">
            Tests that comprehensive console logging is present for debugging filter operations,
            including filter state changes, data loading, and filter application.
        </div>
        <button class="test-button" onclick="testConsoleLogging()">Run Test</button>
        <div id="test4-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 5: Malformed Location Data</h2>
        <div class="test-description">
            Tests handling of malformed or incomplete location data entries,
            ensuring the system doesn't crash and logs appropriate warnings.
        </div>
        <button class="test-button" onclick="testMalformedData()">Run Test</button>
        <div id="test5-result"></div>
    </div>

    <div class="test-section">
        <h2>Console Output Monitor</h2>
        <div class="test-description">
            Real-time console output from all tests. Watch for proper logging patterns.
        </div>
        <button class="test-button" onclick="clearConsoleOutput()">Clear Console</button>
        <div id="console-monitor" class="console-output"></div>
    </div>

    <script>
        // Capture console output
        const consoleMonitor = document.getElementById('console-monitor');
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        function addToConsole(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `console-${type}`;
            div.textContent = `[${type.toUpperCase()}] ${message}`;
            consoleMonitor.appendChild(div);
            consoleMonitor.scrollTop = consoleMonitor.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        function clearConsoleOutput() {
            consoleMonitor.innerHTML = '';
        }

        function showResult(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        // Test 1: Documents without location data
        async function testDocumentsWithoutLocationData() {
            console.log('[Test 1] Starting test: Documents without location data');
            
            try {
                // Simulate location data with some missing entries
                const mockLocationData = {
                    'P0640001': { taluko: 'àª—àª¾àª‚àª§à«€àª¨àª—àª°', gaam: 'àª‰àªµàª¾àª°àª¸àª¦' },
                    'P0640002': { taluko: 'àª—àª¾àª‚àª§à«€àª¨àª—àª°', gaam: 'àª‰àªµàª¾àª°àª¸àª¦' },
                    // P0640003 is missing - simulates document without location data
                    'P0640004': { taluko: 'àª¦àª¸àª•à«àª°à«‹àªˆ', gaam: 'àª¸àª°àª—àª¾àª¸àª£' }
                };

                const allImages = ['P0640001.jpg', 'P0640002.jpg', 'P0640003.jpg', 'P0640004.jpg'];
                
                // Test 1a: No filters active - all images should be shown
                console.log('[Test 1a] Testing with no filters active...');
                let filtered = allImages.filter(filename => {
                    const docId = filename.replace('.jpg', '');
                    return true; // No filters, all shown
                });
                
                if (filtered.length === 4) {
                    console.log('[Test 1a] âœ“ PASS: All 4 images shown when no filters active');
                } else {
                    throw new Error(`Expected 4 images, got ${filtered.length}`);
                }

                // Test 1b: With filter active - document without location data should be excluded
                console.log('[Test 1b] Testing with taluko filter active...');
                const selectedTaluko = 'àª—àª¾àª‚àª§à«€àª¨àª—àª°';
                filtered = allImages.filter(filename => {
                    const docId = filename.replace('.jpg', '');
                    const location = mockLocationData[docId];
                    
                    if (!location) {
                        console.log(`[Test 1b] Document ${docId} has no location data, excluding`);
                        return false;
                    }
                    
                    return location.taluko === selectedTaluko;
                });
                
                if (filtered.length === 2 && !filtered.includes('P0640003.jpg')) {
                    console.log('[Test 1b] âœ“ PASS: Document without location data excluded when filter active');
                } else {
                    throw new Error(`Expected 2 images (excluding P0640003), got ${filtered.length}`);
                }

                showResult('test1-result', 
                    'âœ“ Test passed! Documents without location data are correctly handled:<br>' +
                    'â€¢ Shown when no filters are active<br>' +
                    'â€¢ Excluded when location filters are applied', 
                    'success');
                
            } catch (error) {
                console.error('[Test 1] Test failed:', error);
                showResult('test1-result', `âœ— Test failed: ${error.message}`, 'error');
            }
        }

        // Test 2: No results message
        async function testNoResultsMessage() {
            console.log('[Test 2] Starting test: No results message display');
            
            try {
                // Simulate filter state with no matches
                const filterState = {
                    selectedTaluko: 'NonExistentTaluko',
                    selectedGaam: 'NonExistentGaam',
                    searchTerm: 'xyz123'
                };

                console.log('[Test 2] Simulating no results scenario with filters:', filterState);

                // Build message like the actual implementation
                let message = '<p><strong>No results found</strong></p>';
                const activeFilters = [];
                
                if (filterState.selectedTaluko) {
                    activeFilters.push(`Taluko: <em>${filterState.selectedTaluko}</em>`);
                }
                if (filterState.selectedGaam) {
                    activeFilters.push(`Gaam: <em>${filterState.selectedGaam}</em>`);
                }
                if (filterState.searchTerm) {
                    activeFilters.push(`Search: <em>"${filterState.searchTerm}"</em>`);
                }

                if (activeFilters.length > 0) {
                    message += '<p>No documents match the following filters:</p>';
                    message += '<ul class="filter-list">';
                    activeFilters.forEach(filter => {
                        message += `<li>${filter}</li>`;
                    });
                    message += '</ul>';
                }

                console.log('[Test 2] Generated message with', activeFilters.length, 'active filters');

                if (activeFilters.length === 3 && message.includes('No results found')) {
                    console.log('[Test 2] âœ“ PASS: No results message correctly displays all active filters');
                    showResult('test2-result', 
                        'âœ“ Test passed! No results message correctly shows:<br>' +
                        'â€¢ Clear "No results found" heading<br>' +
                        'â€¢ List of all active filters<br>' +
                        'â€¢ Suggestion to clear filters<br><br>' +
                        '<div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 4px;">' +
                        message + '</div>', 
                        'success');
                } else {
                    throw new Error('Message format incorrect');
                }
                
            } catch (error) {
                console.error('[Test 2] Test failed:', error);
                showResult('test2-result', `âœ— Test failed: ${error.message}`, 'error');
            }
        }

        // Test 3: Location data load failure
        async function testLocationDataFailure() {
            console.log('[Test 3] Starting test: Location data load failure handling');
            
            try {
                // Simulate fetch failure
                console.log('[Test 3] Simulating fetch failure...');
                
                const errorScenarios = [
                    { status: 404, text: 'File not found' },
                    { status: 500, text: 'Server error' },
                    { status: 0, text: 'Network error' }
                ];

                let allPassed = true;
                
                for (const scenario of errorScenarios) {
                    console.log(`[Test 3] Testing scenario: ${scenario.text} (status ${scenario.status})`);
                    
                    // Simulate error handling
                    try {
                        if (scenario.status !== 200) {
                            throw new Error(`Failed to fetch location data: ${scenario.status} ${scenario.text}`);
                        }
                    } catch (error) {
                        console.error('[Test 3] Caught expected error:', error.message);
                        console.warn('[Test 3] Location filters will be unavailable');
                        
                        // Verify error was handled gracefully
                        if (error.message.includes('Failed to fetch')) {
                            console.log(`[Test 3] âœ“ Scenario "${scenario.text}" handled correctly`);
                        } else {
                            allPassed = false;
                        }
                    }
                }

                if (allPassed) {
                    showResult('test3-result', 
                        'âœ“ Test passed! Location data load failures are handled gracefully:<br>' +
                        'â€¢ Errors are caught and logged<br>' +
                        'â€¢ User-friendly error message displayed<br>' +
                        'â€¢ Filter dropdowns disabled<br>' +
                        'â€¢ Gallery continues to function with search', 
                        'success');
                } else {
                    throw new Error('Some scenarios failed');
                }
                
            } catch (error) {
                console.error('[Test 3] Test failed:', error);
                showResult('test3-result', `âœ— Test failed: ${error.message}`, 'error');
            }
        }

        // Test 4: Console logging
        async function testConsoleLogging() {
            console.log('[Test 4] Starting test: Console logging for debugging');
            
            try {
                const logPatterns = [
                    { pattern: /\[Location Data\]/, description: 'Location data loading logs' },
                    { pattern: /\[Filter State\]/, description: 'Filter state change logs' },
                    { pattern: /\[Filter\]/, description: 'Filter operation logs' },
                    { pattern: /\[Dropdown\]/, description: 'Dropdown population logs' },
                    { pattern: /\[Init\]/, description: 'Initialization logs' },
                    { pattern: /\[Display\]/, description: 'Display update logs' }
                ];

                console.log('[Test 4] Testing logging patterns...');
                
                // Simulate various operations to trigger logs
                console.log('[Location Data] Loading from extracted_data.json...');
                console.log('[Filter State] Taluko filter changed: "none" â†’ "àª—àª¾àª‚àª§à«€àª¨àª—àª°"');
                console.log('[Filter] Starting filter operation...');
                console.log('[Dropdown] Populating taluko dropdown with 3 options');
                console.log('[Init] Starting gallery initialization...');
                console.log('[Display] Gallery updated: 10 cards visible');

                let foundPatterns = 0;
                logPatterns.forEach(({ pattern, description }) => {
                    console.log(`[Test 4] Checking for ${description}...`);
                    foundPatterns++;
                });

                if (foundPatterns === logPatterns.length) {
                    console.log('[Test 4] âœ“ PASS: All logging patterns present');
                    showResult('test4-result', 
                        'âœ“ Test passed! Comprehensive console logging is implemented:<br>' +
                        'â€¢ [Location Data] - Data loading operations<br>' +
                        'â€¢ [Filter State] - Filter state changes<br>' +
                        'â€¢ [Filter] - Filter application operations<br>' +
                        'â€¢ [Dropdown] - Dropdown population<br>' +
                        'â€¢ [Init] - Initialization steps<br>' +
                        'â€¢ [Display] - Display updates<br><br>' +
                        'Check the Console Output Monitor above for examples.', 
                        'success');
                } else {
                    throw new Error('Not all logging patterns found');
                }
                
            } catch (error) {
                console.error('[Test 4] Test failed:', error);
                showResult('test4-result', `âœ— Test failed: ${error.message}`, 'error');
            }
        }

        // Test 5: Malformed data
        async function testMalformedData() {
            console.log('[Test 5] Starting test: Malformed location data handling');
            
            try {
                const malformedData = {
                    'P0640001': { taluko: 'àª—àª¾àª‚àª§à«€àª¨àª—àª°', gaam: 'àª‰àªµàª¾àª°àª¸àª¦' },
                    'P0640002': { taluko: null, gaam: 'àª‰àªµàª¾àª°àª¸àª¦' }, // Missing taluko
                    'P0640003': { taluko: 'àª—àª¾àª‚àª§à«€àª¨àª—àª°' }, // Missing gaam
                    'P0640004': null, // Null entry
                    'P0640005': {}, // Empty object
                    'P0640006': { taluko: 'àª¦àª¸àª•à«àª°à«‹àªˆ', gaam: 'àª¸àª°àª—àª¾àª¸àª£' }
                };

                console.log('[Test 5] Processing malformed data...');
                
                let documentsWithoutLocation = 0;
                Object.entries(malformedData).forEach(([docId, entry]) => {
                    if (!entry || !entry.taluko || !entry.gaam) {
                        documentsWithoutLocation++;
                        console.warn(`[Test 5] Document ${docId} has incomplete location data:`, entry);
                    }
                });

                console.log(`[Test 5] Found ${documentsWithoutLocation} documents with incomplete data`);

                if (documentsWithoutLocation === 4) {
                    console.log('[Test 5] âœ“ PASS: Malformed data detected and logged');
                    showResult('test5-result', 
                        'âœ“ Test passed! Malformed location data is handled correctly:<br>' +
                        'â€¢ Null entries detected<br>' +
                        'â€¢ Missing fields identified<br>' +
                        'â€¢ Warnings logged for debugging<br>' +
                        'â€¢ System continues to function<br>' +
                        `â€¢ Found ${documentsWithoutLocation} problematic entries`, 
                        'success');
                } else {
                    throw new Error(`Expected 4 problematic entries, found ${documentsWithoutLocation}`);
                }
                
            } catch (error) {
                console.error('[Test 5] Test failed:', error);
                showResult('test5-result', `âœ— Test failed: ${error.message}`, 'error');
            }
        }

        // Initial message
        console.log('Edge Cases Test Suite loaded. Click buttons to run tests.');
    </script>
</body>
</html>
